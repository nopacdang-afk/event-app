<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Har Ghar Tiranga Event Details</title>
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.22.10/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body {
            background: linear-gradient(135deg, #ff9933 0%, #ffffff 50%, #138808 100%);
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            position: relative;
            overflow-x: hidden;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
        }
        .input-focus {
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .input-focus:focus {
            border-color: #ff9933;
            box-shadow: 0 0 0 4px rgba(255, 153, 51, 0.3);
            background: white;
        }
        .button {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        .button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300%;
            height: 300%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s ease;
            border-radius: 50%;
        }
        .button:hover::after {
            transform: translate(-50%, -50%) scale(1);
        }
        .table-header {
            background: linear-gradient(to right, #ff9933, #138808);
            color: white;
        }
        .table-row {
            transition: background 0.2s ease;
        }
        .table-row:hover {
            background: rgba(255, 255, 255, 0.9);
        }
        .flag-icon {
            animation: wave 2s infinite ease-in-out;
        }
        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(10deg); }
        }
        .bg-decoration {
            position: absolute;
            opacity: 0.1;
            z-index: -1;
        }
        .bg-flag {
            background: url('https://upload.wikimedia.org/wikipedia/en/thumb/4/41/Flag_of_India.svg/1200px-Flag_of_India.svg.png') no-repeat center;
            background-size: contain;
            width: 200px;
            height: 133px;
            top: 10%;
            left: 5%;
            animation: float 6s ease-in-out infinite;
        }
        .bg-chakra {
            background: url('https://upload.wikimedia.org/wikipedia/commons/thumb/1/17/Ashoka_Chakra.svg/1200px-Ashoka_Chakra.svg.png') no-repeat center;
            background-size: contain;
            width: 150px;
            height: 150px;
            bottom: 10%;
            right: 5%;
            animation: spin 20s linear infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="bg-decoration bg-flag"></div>
    <div class="bg-decoration bg-chakra"></div>
    <div id="root"></div>
    <script type="text/babel">
        function App() {
            const blocks = [
                'Achabal', 'Anantnag', 'Bijbehara', 'Breng', 'Chittergul', 'D. Pora', 
                'Hiller', 'K. Pora', 'Larnoo', 'Pahalgam', 'Qazigund', 'Sagam', 
                'Shahabad', 'Shangus', 'Verinag', 'Vessu'
            ];
            const eventNumbers = Array.from({length: 16}, (_, i) => i);
            // Replace with your Render server URL after deployment, e.g., 'https://your-app.onrender.com'
            const SERVER_URL = 'https://event-server-hkf7.onrender.com';

            const [formData, setFormData] = React.useState({
                block: blocks[0],
                events: 0,
                remarks: ''
            });
            const [savedData, setSavedData] = React.useState([]);
            const [error, setError] = React.useState(null);
            const [isAdmin, setIsAdmin] = React.useState(false);
            const [passwordInput, setPasswordInput] = React.useState('');

            React.useEffect(() => {
                const fetchData = async () => {
                    try {
                        const response = await fetch(`${SERVER_URL}/data`, {
                            mode: 'cors'
                        });
                        if (!response.ok) {
                            throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
                        }
                        const data = await response.json();
                        setSavedData(data);
                        console.log('Data fetched from server:', data);
                    } catch (err) {
                        console.error('Fetch error:', err);
                        setError('Failed to load data from server. Please check if the server is running or contact support.');
                    }
                };
                fetchData();
            }, []);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                console.log(`Input changed: ${name} = ${value}`);
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handlePasswordChange = (e) => {
                setPasswordInput(e.target.value);
            };

            const handleAdminLogin = async () => {
                try {
                    const response = await fetch(`${SERVER_URL}/admin-login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: passwordInput })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Login failed');
                    setIsAdmin(true);
                    setError(null);
                    setPasswordInput('');
                    console.log('Admin login successful');
                } catch (err) {
                    console.error('Login error:', err);
                    setError('Incorrect password. Please try again.');
                }
            };

            const handleSave = async () => {
                try {
                    const response = await fetch(`${SERVER_URL}/save`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Failed to save data');
                    setSavedData(result);
                    setFormData({
                        block: blocks[0],
                        events: 0,
                        remarks: ''
                    });
                    setError(null);
                    console.log('Data saved to server:', formData);
                } catch (err) {
                    console.error('Save error:', err);
                    setError(err.message || 'Failed to save data. Please try again.');
                }
            };

            const handleClearData = async () => {
                try {
                    const response = await fetch(`${SERVER_URL}/clear-data`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: passwordInput })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Failed to clear data');
                    setSavedData([]);
                    localStorage.removeItem('eventData');
                    setError('All data cleared successfully.');
                    console.log('Data cleared successfully');
                } catch (err) {
                    console.error('Clear data error:', err);
                    setError('Failed to clear data. Incorrect password or server error.');
                }
            };

            const handleDownload = async () => {
                try {
                    if (savedData.length === 0) {
                        setError('No data to send.');
                        return;
                    }
                    const response = await fetch(`${SERVER_URL}/send-csv`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: passwordInput, data: savedData })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'Failed to send CSV');

                    const csvContent = [
                        'Block,Number of Events,Remarks',
                        ...savedData.map(item => 
                            `${item.block},${item.events},"${item.remarks.replace(/"/g, '""')}"`
                        )
                    ].join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'har_ghar_tiranga.csv');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    setError(result.message + ' Also, please manually attach the downloaded CSV to an email to nopacdang@gmail.com if server email failed.');
                    console.log('CSV sent and downloaded successfully');
                } catch (err) {
                    console.error('Send error:', err);
                    setError('Failed to send CSV. Please download and manually email to nopacdang@gmail.com.');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-6">
                    <div className="card max-w-4xl w-full p-10">
                        <h1 className="text-4xl font-bold text-gray-800 mb-8 text-center flex items-center justify-center">
                            <i className="fas fa-flag flag-icon text-3xl mr-3 text-orange-600"></i>
                            Har Ghar Tiranga Event Details
                            <i className="fas fa-flag flag-icon text-3xl ml-3 text-green-600"></i>
                        </h1>
                        
                        {error && (
                            <div className="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-8 flex items-center animate-pulse">
                                <i className="fas fa-exclamation-circle mr-3 text-red-500"></i>
                                {error}
                            </div>
                        )}

                        <div className="space-y-8">
                            <div className="relative">
                                <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                    <i className="fas fa-map-marker-alt mr-2 text-orange-500"></i> Block
                                </label>
                                <select 
                                    name="block"
                                    value={formData.block}
                                    onChange={handleInputChange}
                                    className="input-focus block w-full rounded-lg border-gray-300 shadow-sm focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50 p-4 text-gray-700"
                                >
                                    {blocks.map(block => (
                                        <option key={block} value={block}>{block}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="relative">
                                <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                    <i className="fas fa-calendar-check mr-2 text-green-500"></i> Number of Events
                                </label>
                                <select 
                                    name="events"
                                    value={formData.events}
                                    onChange={handleInputChange}
                                    className="input-focus block w-full rounded-lg border-gray-300 shadow-sm focus:border-green-500 focus:ring focus:ring-green-200 focus:ring-opacity-50 p-4 text-gray-700"
                                >
                                    {eventNumbers.map(num => (
                                        <option key={num} value={num}>{num}</option>
                                    ))}
                                </select>
                            </div>

                            <div className="relative">
                                <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                    <i className="fas fa-comment-alt mr-2 text-blue-500"></i> Remarks
                                </label>
                                <textarea
                                    name="remarks"
                                    value={formData.remarks}
                                    onChange={handleInputChange}
                                    className="input-focus block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-4 text-gray-700"
                                    rows="5"
                                    placeholder="Enter your remarks..."
                                ></textarea>
                            </div>

                            <button
                                onClick={handleSave}
                                className="button w-full bg-gradient-to-r from-orange-500 to-green-500 hover:from-orange-600 hover:to-green-600 text-white font-semibold py-4 px-6 rounded-lg flex items-center justify-center"
                            >
                                <i className="fas fa-save mr-2"></i> Save Entry
                            </button>
                        </div>

                        {savedData.length > 0 && (
                            <div className="mt-10">
                                <h2 className="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                                    <i className="fas fa-table mr-2 text-blue-600"></i> Saved Data
                                </h2>
                                <div className="overflow-x-auto rounded-lg border border-gray-200">
                                    <table className="min-w-full divide-y divide-gray-200">
                                        <thead className="table-header">
                                            <tr>
                                                <th className="px-6 py-4 text-left text-sm font-semibold">Block</th>
                                                <th className="px-6 py-4 text-left text-sm font-semibold">Events</th>
                                                <th className="px-6 py-4 text-left text-sm font-semibold">Remarks</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-200">
                                            {savedData.map((item, index) => (
                                                <tr key={index} className="table-row">
                                                    <td className="px-6 py-4 whitespace-nowrap text-gray-700">{item.block}</td>
                                                    <td className="px-6 py-4 whitespace-nowrap text-gray-700">{item.events}</td>
                                                    <td className="px-6 py-4 text-gray-700">{item.remarks}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {!isAdmin && (
                                    <div className="mt-8">
                                        <label className="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                                            <i className="fas fa-lock mr-2 text-gray-500"></i> Admin Password
                                        </label>
                                        <input
                                            type="password"
                                            value={passwordInput}
                                            onChange={handlePasswordChange}
                                            className="input-focus block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-4 text-gray-700"
                                            placeholder="Enter admin password"
                                        />
                                        <button
                                            onClick={handleAdminLogin}
                                            className="button w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-4 px-6 rounded-lg mt-4 flex items-center justify-center"
                                        >
                                            <i className="fas fa-sign-in-alt mr-2"></i> Login as Admin
                                        </button>
                                    </div>
                                )}

                                {isAdmin && (
                                    <div className="mt-8 space-y-4">
                                        <button
                                            onClick={handleDownload}
                                            className="button w-full bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-semibold py-4 px-6 rounded-lg flex items-center justify-center"
                                        >
                                            <i className="fas fa-download mr-2"></i> Download CSV and Email
                                        </button>
                                        <button
                                            onClick={handleClearData}
                                            className="button w-full bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600 text-white font-semibold py-4 px-6 rounded-lg flex items-center justify-center"
                                        >
                                            <i className="fas fa-trash-alt mr-2"></i> Clear All Data
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
            console.log('React app rendered successfully');
        } catch (err) {
            console.error('Render error:', err);
            document.getElementById('root').innerHTML = '<div className="text-red-500 p-4">Error loading application. Please check console for details.</div>';
        }
    </script>
</body>
</html>